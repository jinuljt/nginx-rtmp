# Repository Guidelines

## Project Structure & Module Organization
- `Dockerfile` builds the Alpine 3.20 image, compiles nginx 1.26 with `nginx-rtmp-module`, and layers the Flask manager; touch this file whenever dependency versions or runtime layout change.
- `nginx.conf` defines the RTMP application and HTTP status site; it now `include`s `/etc/nginx/conf.d/rtmp_pushes.conf` which is generated by the manager.
- `manager/` hosts the Flask UI (`app.py`, `templates/`) and is copied to `/opt/rtmp-manager`; keep web assets lightweight and dependency-free.
- `nginx.d/rtmp_pushes.conf` is a placeholder shipped in the image—avoid manual edits, rely on the manager instead.
- `README.md` remains the client-facing guide (Chinese-first); mirror any workflow changes here and append English notes when useful for global users.
- `docs/requirements.md` tracks product requirements; update it whenever behaviour or scope changes。
- `.github/workflows/docker-image.yml` 实现 GHCR 镜像构建发布流程；改动构建逻辑、镜像名称或推送策略时务必同步维护。
- `沟通与流程`: 参见文末流程准则，保持沟通一致性。

## Build, Test, and Development Commands
- `docker build -t nginx-rtmp:dev .` rebuilds the image locally with the latest sources; rerun whenever the Dockerfile or dependencies change.
- `docker run --rm -p 1935:1935 -p 5000:5000 nginx-rtmp:dev` launches the stack for manual verification; the RTMP stat feed remains internal on `127.0.0.1:8080`.
- `docker exec nginx-rtmp nginx -t` validates `nginx.conf` syntax; expect `syntax is ok`.
- `curl -s http://localhost:5000/api/sources` quickly confirms the Flask manager is reachable and returning the current push list.
- `curl -s http://localhost:5000/stat` should render the integrated状态页；若失败可在容器内请求 `http://127.0.0.1:8080/rtmp_stat` 排查。
- `gh workflow run docker 镜像构建` 可在本地触发手动构建；正式流程由推送 `master` 自动执行。

## Coding Style & Naming Conventions
- Keep Dockerfile instructions uppercase with one logical change per layer to minimise cache busts; pin explicit versions (e.g. `ARG NGINX_VERSION=1.26.2`).
- Use four-space indentation in `nginx.conf`, align directives vertically, and favour lowercase identifiers (`app`, `live`) to match current naming.
- In Flask views, keep logic inside helper functions and bubble user-facing messages via `flash`; avoid external dependencies beyond Flask + Gunicorn.
- Python依赖通过 `/opt/rtmp-manager/.venv` 虚拟环境安装；别在系统 Python 中追加包。
- 新增 Flask 路由时，提供模板并在导航中链接；若依赖 Nginx 内部接口，兼顾异常处理与用户提示。

## 沟通与流程准则
- 团队沟通与文档更新默认使用中文，保持风格一致。
- 提交信息（git commit message）必须使用中文描述变更内容。
- 每次需求或流程调整后，及时同步更新本指南与 `docs/requirements.md`。
- Comment non-obvious RTMP pushes or auth blocks so downstream operators understand the streaming pipeline.

## Testing Guidelines
- There is no automated test suite; rely on `nginx -t`, container start logs, and manual streaming checks.
- Confirm `http://localhost:8080/stat` loads and shows active streams after pushing test traffic（如 OBS 使用 `rtmp://localhost:1935/app/stream_key`）.
- Exercise the manager by adding/removing push URLs through `http://localhost:5000/`; inspect `/etc/nginx/conf.d/rtmp_pushes.conf` to ensure updates.
- Capture the commands and observations in the PR description so reviewers can reproduce.

## Commit & Pull Request Guidelines
- Existing commits are concise and action-oriented; follow that style and include scope prefixes when helpful (e.g. `build: refresh base image`, `config: tighten rtmp auth`).
- For each PR, describe the motivation, list configuration changes, and note how you validated streaming paths; attach screenshots of the stat page if UI output changed.
- Link to related issues or deployment notes and request review from maintainers responsible for Docker image releases.

## Configuration Tips
- Place environment-specific overrides in a separate `.conf` file and mount it with `-v custom.conf:/etc/nginx/conf.d/custom.conf` to keep the base config generic.
- When modifying RTMP applications, keep keys stable across environments to avoid breaking existing client presets; document any required DNS or firewall updates.

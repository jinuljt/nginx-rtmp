# nginx-rtmp 需求说明

## 项目背景
为直播推流场景提供一个开箱即用的 Nginx-RTMP Docker 镜像，同时解决旧版本依赖过时、推送源需手动编辑配置并重启的问题。新版本要求支持现代系统、快速扩展与自动化运维能力。

## 总体目标
- 保持 Nginx RTMP 服务稳定运行，兼容常见直播设备（PS4/PS5、OBS 等）。
- 提供 Web 控制面板，实现推送源的图形化增删并自动重载 Nginx。
- 维护清晰的文档体系，便于贡献者和使用者快速上手。

## 功能性需求
1. **容器化服务**  
   - 基于最新稳定的 Alpine Linux 与 Nginx（当前目标：Alpine 3.20，Nginx 1.26.x）。  
   - 编译集成 `nginx-rtmp-module`，默认启用 `app` 应用，监听 `1935` 端口。  
2. **状态与监控**  
   - 暴露 HTTP 状态页 `http://<host>:8080/stat`，用于实时查看推流状态。  
3. **推送源管理**  
   - 内置 Flask Web 服务（默认端口 5000），支持列出、添加、删除 RTMP/RTMPS 推送地址。  
   - 所有推送地址写入 `/etc/nginx/conf.d/rtmp_pushes.conf`，变更后自动执行 `nginx -s reload`。  
   - 提供 REST API `GET /api/sources` 返回当前推送列表。  
4. **数据持久化**  
   - 推送源 JSON 数据存储于 `/var/lib/nginx-manager/push_sources.json`，支持挂载外部卷。  
5. **容器协程管理**  
   - 使用 Supervisor 管理 Nginx 与 Flask 进程，确保任一进程崩溃后自动重启。

## 非功能性需求
- **可维护性**：Dockerfile 与配置文件使用模块化 `include`，新增推送源无需手动编辑主配置。  
- **可移植性**：镜像需同时兼容 `x86_64` 与 `arm64` 架构。  
- **安全性**：默认拒绝非 RTMP 协议地址；未来扩展需支持推送源认证。  
- **可观察性**：提供日志重定向到 stdout/stderr，方便通过 `docker logs` 查看运行状况。

## 文档与流程要求
- README 描述主要功能、端口映射及使用指南，并保持镜像名称、版本同步。  
- `AGENTS.md` 提供贡献指南，说明项目结构、开发命令与测试流程。  
- 本需求文档在每次需求调整时同步更新，记录变更日期与责任人（在新增章节或变更说明中注明）。

## 后续规划（可选）
- 支持自定义多 RTMP 应用与推送模板。  
- 集成认证机制（例如推送密钥校验）。  
- 增加基础自动化测试，覆盖 `nginx -t`、API 接口可用性与示例推流验证。
